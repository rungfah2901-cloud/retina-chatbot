from fastapi import FastAPI, Request, HTTPException
from linebot import LineBotApi, WebhookHandler
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from dotenv import load_dotenv
import os

load_dotenv()

app = FastAPI()
line_bot_api = LineBotApi(os.getenv("LINE_CHANNEL_ACCESS_TOKEN"))
handler = WebhookHandler(os.getenv("LINE_CHANNEL_SECRET"))

faq = {
    "‡∏â‡∏µ‡∏î‡∏¢‡∏≤": "‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ß‡∏∏‡πâ‡∏ô‡∏ï‡∏≤ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 30-60 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡πá‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏≠‡∏î‡∏¢‡∏≤‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞",
    "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß": "‡∏Å‡πà‡∏≠‡∏ô‡∏â‡∏µ‡∏î‡∏¢‡∏≤: ‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏™‡∏£‡∏∞‡∏ú‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏ó‡∏Ñ‡πÄ‡∏•‡∏ô‡∏™‡πå ‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞",
    "‡∏´‡∏•‡∏±‡∏á‡∏â‡∏µ‡∏î": "‡∏´‡∏•‡∏±‡∏á‡∏â‡∏µ‡∏î‡∏¢‡∏≤ ‡∏ï‡∏≤‡∏≠‡∏≤‡∏à‡πÅ‡∏î‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏≤‡∏Å ‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏•‡∏á‡∏â‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡πÅ‡∏î‡∏á‡∏°‡∏≤‡∏Å ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡∏°‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
    "‡∏ô‡∏±‡∏î": "‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ OPD ‡∏ï‡∏≤ ‡πÇ‡∏ó‡∏£ 055-022-000 ‡∏ï‡πà‡∏≠ 2501 ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 14.00-16.00 ‡∏ô. ‡∏Ñ‡πà‡∏∞",
    "‡∏à‡∏≠‡∏ï‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°": "‡πÇ‡∏£‡∏Ñ‡∏à‡∏≠‡∏ï‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å (Wet AMD) ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡∏ï‡πâ‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î (anti-VEGF) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ß‡∏∏‡πâ‡∏ô‡∏ï‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏ö‡∏¢‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÉ‡∏ï‡πâ‡∏à‡∏≠‡∏ï‡∏≤ ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏∞‡∏•‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏ö‡∏≠‡∏î‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏â‡∏µ‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£",
    "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô": "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠‡∏ï‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ß‡∏∏‡πâ‡∏ô‡∏ï‡∏≤ (Intravitreal Injection) ‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡∏ö‡∏ß‡∏° (DME) ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏á‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏ß‡∏∏‡πâ‡∏ô‡∏ï‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ï‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (Anti-VEGF) ‡∏â‡∏µ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏ö‡∏ß‡∏° ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ HbA1c < 7% ‡∏Ñ‡πà‡∏∞",
    "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤ ER ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ: ‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏•‡∏á‡∏â‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏ô ‡∏õ‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏≤‡∏Å ‡∏ï‡∏≤‡πÅ‡∏î‡∏á‡∏°‡∏≤‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏°‡∏µ‡∏´‡∏ô‡∏≠‡∏á‡∏ï‡∏≤ ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏™‡∏á‡∏ß‡∏≤‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡πá‡∏ô‡∏°‡πà‡∏≤‡∏ô‡∏î‡∏≥‡∏Ñ‡πà‡∏∞",
}

def get_faq_answer(message):
    for keyword, answer in faq.items():
        if keyword in message:
            return answer
    return "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡πà‡∏∞ üòä ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞:\n\nüíâ ‡∏â‡∏µ‡∏î‡∏¢‡∏≤\nüìã ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß\nüè• ‡∏´‡∏•‡∏±‡∏á‡∏â‡∏µ‡∏î\nüìÖ ‡∏ô‡∏±‡∏î\nüëÅ ‡∏à‡∏≠‡∏ï‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°\nü©∫ ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô\nüö® ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô"
@app.get("/")
def read_root():
    return {"status": "Retina Chatbot Running!"}

@app.post("/webhook")
async def webhook(request: Request):
    signature = request.headers.get("X-Line-Signature")
    body = await request.body()
    try:
        handler.handle(body.decode(), signature)
    except Exception as e:
        raise HTTPException(status_code=400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_message = event.message.text
    reply = get_faq_answer(user_message)
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=reply)
    ]